<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air totem</title>
    <link rel="shortcut icon" href="../assets/icon/IconAirTotem.ico.jpg">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/menu.css">
    <link rel="stylesheet" href="../css/perfil.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
</head>
<body onload="validarSessao()">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="../js/adm.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
      </style>

    <div class="div-telaPerfil">
    
        <div class="div-menu-lateral">

            <div class="div-menu-cabecalhoEmpresa">
              <!-- <img src="../assets/imgs/App Icon.svg" alt="blabla"> -->
              <p id="nome_empresa"></p>
            </div>
            <div class="div-menu-TipoUsuario">
              <img src="../assets/imgs/Avatar.svg" alt="blabla">
                <p id="b_usuario">Administrador</p>
            </div>
            <div class="div-menu-dadosLateral">
              <li><box-icon name='exit' color='#16b1ff' ></box-icon><a onclick="limparSessao()" style="cursor: pointer;">Encerrar sessão</a></li>
            </div>
        </div>

        <div class="TelaADM" style="height: 100%; background-color: #E9EBF0;">

        <div class="tituloAdm">
          <h3>Usuários</h3>
        </div> 
          
        <div class="conteudoMeioADM">
          <div class="container text-center">
            <div class="row">
              <div class="col-6">
                <div class="mb-3">
                  <input type="text" class="form-control" id="exampleFormControlInput1" placeholder="Pesquisar">
                </div>
              </div>
              <div class="col-3">
                <a href="./cadastroUsuario.html" class="botaoAdd">
                  Adicionar novo usuário
                  <box-icon name='user-plus' color='#FFFFFF'></box-icon>
                </a>
              </div>
              <div class="col-3">
                <a href="./metricas.html" class="botaoAdd">
                  Adicionar métricas
                </a>
              </div>
            </div>
          </div>


          <div class="tabelaMeio" style="padding: 15px;">
            
              <div class="card">
                <div class="card-body">
                    <table class="table-Totens">
                      <tr class="title-table-totens">
                        <td>Nome funcionário</td>
                        <td>Aeroporto</td>
                        <td>Tipo</td>
                        <td>Ações</td>
                      </tr>
                    </table>
                </div>
              </div>
            
          </div>
        </div>
        </div>

        

        </div>

        <script>

        function listarUsuarios() {
            var empresaId = sessionStorage.getItem('ID_EMPRESA');
            var aeroportoId = sessionStorage.getItem('AEROPORTO_ID');

            fetch(`/usuarios/listar/${empresaId}/${aeroportoId}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                const tabela = document.querySelector(".table-Totens tbody");

                data.forEach(usuario => {
                    const novaLinha = document.createElement("tr");
                    novaLinha.setAttribute('data-id', usuario.idUser);

                    const tdNome = document.createElement("td");
                    tdNome.textContent = usuario.nomeUsuario;

                    const tdEmpresa = document.createElement("td");
                    tdEmpresa.textContent = usuario.nomeEmpresa;

                    const tdTipo = document.createElement("td");
                    tdTipo.textContent = usuario.nivelAcesso;

                    const tdAcoes = document.createElement("td");

                    const editLink = document.createElement("a");
                    editLink.href = "#";

                    const deleteLink = document.createElement("a");
                    deleteLink.href = "#";
                    deleteLink.addEventListener('click', function(event) {
                        event.preventDefault();
                        deletarUsuario(usuario.idUser, novaLinha);
                    });
                    const deleteIcon = document.createElement("box-icon");
                    deleteIcon.setAttribute('name', 'trash');
                    deleteIcon.setAttribute('color', '#ef3826');
                    deleteLink.appendChild(deleteIcon);

                    tdAcoes.appendChild(editLink);
                    tdAcoes.appendChild(deleteLink);

                    novaLinha.appendChild(tdNome);
                    novaLinha.appendChild(tdEmpresa);
                    novaLinha.appendChild(tdTipo);
                    novaLinha.appendChild(tdAcoes);

                    tabela.appendChild(novaLinha);
                });
            })
            .catch(error => {
                console.error("Erro ao listar usuários:", error);
            });
        }

        function deletarUsuario(idUser, linha) {
            fetch(`/usuarios/deletar/${idUser}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => {
                if (response.ok) {
                    linha.remove();
                    console.log(`Usuário com id ${idUser} deletado com sucesso.`);
                } else {
                    console.error(`Erro ao deletar o usuário com id ${idUser}.`);
                }
            })
            .catch(error => {
                console.error(`Erro ao deletar o usuário com id ${idUser}:`, error);
            });
        }

        function filtrarUsuarios() {
            const input = document.getElementById('exampleFormControlInput1');
            const filter = input.value.toLowerCase();
            const tabela = document.querySelector(".table-Totens tbody");
            const linhas = tabela.getElementsByTagName('tr');

            for (let i = 0; i < linhas.length; i++) {
                let nome = linhas[i].getElementsByTagName("td")[0];
                let tipo = linhas[i].getElementsByTagName("td")[2];
                if (nome || tipo) {
                    let textoNome = nome.textContent || nome.innerText;
                    let textoTipo = tipo.textContent || tipo.innerText;
                    if (textoNome.toLowerCase().indexOf(filter) > -1 || textoTipo.toLowerCase().indexOf(filter) > -1) {
                        linhas[i].style.display = "";
                    } else {
                        linhas[i].style.display = "none";
                    }
                }       
            }
        }

        // Adiciona o evento de entrada ao campo de pesquisa para filtrar em tempo real
        document.getElementById('exampleFormControlInput1').addEventListener('input', filtrarUsuarios);

        // Chama a função para listar os usuários quando a página é carregada
        window.onload = listarUsuarios;
    </script>